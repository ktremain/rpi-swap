#!/bin/sh

set -e

: "${CONFIG_FILE:=/etc/rpi-swap/swap.conf}"
: "${SWAP_FILE_SIZE_CALC_BIN:=/bin/rpi-desired-swap-size}"

: "${CONF_SWAPFILE:=/var/swap}"
eval "$( \
  apt-config \
    --config-file "${CONFIG_FILE}" \
    shell \
      CONF_SWAPFILE      RpiSwap::Swapfile::Path \
      CONF_SWAPFACTOR    RpiSwap::Swapfile::SwapFactor \
      CONF_MAXDISK_PCT   RpiSwap::Swapfile::MaxDiskPct \
      CONF_MAXSWAP       RpiSwap::Swapfile::MaxSwap \
      CONF_SWAPSIZE      RpiSwap::Swapfile::SwapSize
)"
export \
  CONF_SWAPFILE \
  CONF_SWAPFACTOR \
  CONF_MAXDISK_PCT \
  CONF_MAXSWAP \
  CONF_SWAPSIZE

CONF_SWAPSIZE="$(${SWAP_FILE_SIZE_CALC_BIN})"
CONF_SWAPFILE="$(realpath "${CONF_SWAPFILE}")"

# Note, fallocate can be used to create / grow / but not shrink

if [ "${CONF_SWAPSIZE}" -ne 0 ]; then
  # Now generate file
  UNIT_NAME="$( \
    systemd-escape \
      --path \
      --suffix=swap \
      "${CONF_SWAPFILE}" \
  )"

  cat <<EOF > /run/systemd/generator/"${UNIT_NAME}"
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
After=rpi-resize-var-swap-service.service
Requires=rpi-resize-var-swap-service.service

[Swap]
What=${CONF_SWAPFILE}
EOF

  mkdir -p /run/systemd/generator/swap.target.wants
  ln -s "../${UNIT_NAME}" /run/systemd/generator/swap.target.wants/"${UNIT_NAME}"
elif [ -f "${CONF_SWAPFILE}" ]; then
  cat <<EOF > /run/systemd/generator/rpi-remove-swap-file.service
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
DefaultDependencies=no
After=systemd-remount-fs.service
Requires=systemd-remount-fs.service

[Service]
Type=oneshot
ExecStart=rm -f ${CONF_SWAPFILE}
EOF
  mkdir -p /run/systemd/generator/local-fs.target.wants
  ln -s "../rpi-remove-swap-file.service" /run/systemd/generator/local-fs.target.wants/rpi-remove-swap-file.service
fi
