#!/bin/sh

set -e

: "${CONFIG_FILE:=/etc/rpi-swap/swap.conf}"
: "${SWAP_FILE_SIZE_CALC_BIN:=/bin/rpi-desired-swap-size}"

: "${CONF_SWAPFILE:=/var/swap}"
eval "$( \
  apt-config \
    --config-file "${CONFIG_FILE}" \
    shell \
      CONF_MECHANISM     RpiSwap::Mechanism \
      CONF_SWAPFILE      RpiSwap::Swapfile::Path \
      CONF_SWAPFACTOR    RpiSwap::Swapfile::SwapFactor \
      CONF_MAXDISK_PCT   RpiSwap::Swapfile::MaxDiskPct \
      CONF_MAXSWAP       RpiSwap::Swapfile::MaxSwap \
      CONF_SWAPSIZE      RpiSwap::Swapfile::SwapSize
)"
export \
  CONF_SWAPFILE \
  CONF_SWAPFACTOR \
  CONF_MAXDISK_PCT \
  CONF_MAXSWAP \
  CONF_SWAPSIZE

CONF_SWAPSIZE="$(${SWAP_FILE_SIZE_CALC_BIN})"
CONF_SWAPFILE="$(realpath "${CONF_SWAPFILE}")"

# Note, fallocate can be used to create / grow / but not shrink

# Try and disable zram
#mkdir -p /run/systemd/zram-generator.conf.d
#cat <<EOF > /run/systemd/zram-generator.conf.d/70-rpi-disable-zram.conf
# Automatically generated by rpi-swap-generator

# systemd-zram-generator package enables zram0 as swap by default via
# /etc/systemd/zram-generator.conf
# Disable zram0 unless configuration explicitly requested
#[zram0]
#host-memory-limit=0
#fs-type=none
#EOF

if [ "${CONF_MECHANISM}" = "zram" ]; then
  # This is incomplete, read our configuration and dynamically-create a
  # zram-generator compatible one.
  #
  # The configuration below merely undoes our static configuration in /lib that
  # disables the default-configured zram0.
  mkdir -p /run/systemd/zram-generator.conf.d
  cat <<EOF > /run/systemd/zram-generator.conf.d/80-rpi-enable.zram.conf
# Automatically generated by rpi-swap-generator

[zram0]
host-memory-limit=none
fs-type=swap
EOF

  # Create a swap unit
  cat <<EOF > /run/systemd/generator/dev-zram0.swap
# Automatically generated by rpi-swap-generator

[Unit]
Description=Compressed Swap on /dev/zram0
Requires=systemd-zram-setup@zram0.service
After=systemd-zram-setup@zram0.service

[Swap]
What=/dev/zram0
# TODO: Investigate if this is sensible
Priority=100
Options=discard
EOF

  # Enable our swap unit via the swap.target
  mkdir -p /run/systemd/generator/swap.target.wants
  ln -s "../dev-zram0.swap" /run/systemd/generator/swap.target.wants/dev-zram0.swap

  # Create the bindings
  mkdir -p /run/systemd/generator/systemd-zram-setup@zram0.service.d
  cat <<EOF > /run/systemd/generator/systemd-zram-setup@zram0.service.d/bindings.conf
# Automatically generated by rpi-swap-generator

[Unit]
BindsTo=dev-%i.swap
EOF
fi

if [ "${CONF_MECHANISM}" = "zram+file" ]; then
  BACKING_FILE="$( \
    systemd-escape \
      --path \
      "${CONF_SWAPFILE}" \
  )"
  LOOP_DEVICE="/dev/disk/by-backingfile/${BACKING_FILE}"

  mkdir -p /run/systemd/zram-generator.conf.d
  cat <<EOF > /run/systemd/zram-generator.conf.d/80-rpi-enable.zram.conf
# Automatically generated by rpi-swap-generator

[zram0]
host-memory-limit=none
fs-type=swap
writeback-device=${LOOP_DEVICE}
EOF

  # Create a swap unit
  cat <<EOF > /run/systemd/generator/dev-zram0.swap
# Automatically generated by rpi-swap-generator

[Unit]
Description=Compressed Swap on /dev/zram0
Requires=systemd-zram-setup@zram0.service
After=systemd-zram-setup@zram0.service

[Swap]
What=/dev/zram0
# TODO: Investigate if this is sensible
Priority=100
Options=discard
EOF

  # Enable our swap unit via the swap.target
  mkdir -p /run/systemd/generator/swap.target.wants
  ln -s "../dev-zram0.swap" /run/systemd/generator/swap.target.wants/dev-zram0.swap

  # Create the bindings
  # TODO: Still no resizing support here
  mkdir -p /run/systemd/generator/systemd-zram-setup@zram0.service.d
  cat <<EOF > /run/systemd/generator/systemd-zram-setup@zram0.service.d/bindings.conf
# Automatically generated by rpi-swap-generator

[Unit]
BindsTo=dev-%i.swap rpi-setup-loop@${BACKING_FILE}.service
EOF
fi

# Just bail for now if we're not doing useful things
if [ "${CONF_MECHANISM}" != "swapfile" ]; then
  exit 0
fi

# This is just temporary to see if it works, needs to be better integrated.
# There's also nothing in swaploop path that forces a re-size which is absolutely required!
if [ "${CONF_MECHANISM}" = "swaploop" ]; then
  BACKING_FILE="$( \
    systemd-escape \
      --path \
      "${CONF_SWAPFILE}" \
  )"
  LOOP_DEVICE="/dev/disk/by-backingfile/${BACKING_FILE}"
  UNIT_NAME="$( \
    systemd-escape \
      --path \
      --suffix=swap \
      "${LOOP_DEVICE}" \
  )"
  cat <<EOF > /run/systemd/generator/"${UNIT_NAME}"
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
BindsTo=rpi-setup-loop@${BACKING_FILE}.service

[Swap]
What=${LOOP_DEVICE}
EOF
  # This would *ideally* be swap.target.wants but we get timeout behaviour
  # waiting for the device unit.
  # This doesn't work either... still getting timeout behaviour
  mkdir -p /run/systemd/generator/sysinit.target.wants
  ln -s "../${UNIT_NAME}" /run/systemd/generator/sysinit.target.wants/"${UNIT_NAME}"
  # Force an early exit, we're just experimenting for now
  exit 0
fi

if [ "${CONF_SWAPSIZE}" -ne 0 ]; then
  # Now generate file
  UNIT_NAME="$( \
    systemd-escape \
      --path \
      --suffix=swap \
      "${CONF_SWAPFILE}" \
  )"

  cat <<EOF > /run/systemd/generator/"${UNIT_NAME}"
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
After=rpi-resize-var-swap-service.service
Requires=rpi-resize-var-swap-service.service

[Swap]
What=${CONF_SWAPFILE}
EOF

  mkdir -p /run/systemd/generator/swap.target.wants
  ln -s "../${UNIT_NAME}" /run/systemd/generator/swap.target.wants/"${UNIT_NAME}"
elif [ -f "${CONF_SWAPFILE}" ]; then
  cat <<EOF > /run/systemd/generator/rpi-remove-swap-file.service
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
DefaultDependencies=no
After=systemd-remount-fs.service
Requires=systemd-remount-fs.service

[Service]
Type=oneshot
ExecStart=rm -f ${CONF_SWAPFILE}
EOF
  mkdir -p /run/systemd/generator/local-fs.target.wants
  ln -s "../rpi-remove-swap-file.service" /run/systemd/generator/local-fs.target.wants/rpi-remove-swap-file.service
fi
