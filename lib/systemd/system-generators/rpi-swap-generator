#!/bin/sh

set -e

#/etc/rpi-swap/swap.conf
# DphysSwapfile {
#   SwapFactor "1";
#   MaxSwap "2048";
#   MaxDiskPct "50";
# };

: "${CONFIG_FILE:=/etc/rpi-swap/swap.conf}"
: "${SWAP_FILE_SIZE_CALC_BIN:=/bin/rpi-desired-swap-size}"

: "${CONF_SWAPFILE:=/var/swap}"
eval "$( \
  apt-config \
    --config-file "${CONFIG_FILE}" \
    shell \
      CONF_SWAPFILE      DphysSwapfile::SwapFile \
      CONF_SWAPFACTOR    DphysSwapfile::SwapFactor \
      CONF_MAXDISK_PCT   DphysSwapfile::MaxDiskPct \
      CONF_MAXSWAP       DphysSwapfile::MaxSwap \
      CONF_SWAPSIZE      DphysSwapfile::SwapSize
)"
export \
  CONF_SWAPFILE \
  CONF_SWAPFACTOR \
  CONF_MAXDISK_PCT \
  CONF_MAXSWAP \
  CONF_SWAPSIZE

CONF_SWAPSIZE="$(${SWAP_FILE_SIZE_CALC_BIN})"
CONF_SWAPFILE="$(realpath "${CONF_SWAPFILE}")"
echo "Desired swap size is: $CONF_SWAPSIZE"
echo "Desired swap file is: $CONF_SWAPFILE"

# Note, fallocate can be used to create / grow / but not shrink

if [ $CONF_SWAPSIZE -eq 0 ]; then
  if [ -f $CONF_SWAPFILE ]; then
    echo "Delete the swapfile that we don't want anymore"
    rm -f "$CONF_SWAPFILE"
  fi
else
  if [ -f "$CONF_SWAPFILE" ]; then
    echo "It exists... we should work out if it's the correct size or if it needs to be made larger or smaller"
    CURRENT_SIZE="$( \
      du \
        --apparent-size \
        --block-size=M \
        "${CONF_SWAPFILE}" | \
          grep -oP '^\d+(?=M)' \
    )"
    echo "The current size is: $CURRENT_SIZE"
    if [ "${CONF_SWAPSIZE}" -gt "${CURRENT_SIZE}" ]; then
      echo "Need to grow file"
      fallocate \
        --posix \
        --length "${CONF_SWAPSIZE}M" \
        "${CONF_SWAPFILE}"
    elif [ "${CONF_SWAPSIZE}" -lt "${CURRENT_SIZE}" ]; then
      echo "Need to shrink file"
      truncate \
        --size "${CONF_SWAPSIZE}M" \
        "${CONF_SWAPFILE}"
    else
      echo "File is properly sized"
    fi
  else
    echo "Swap file needs to be created"
    fallocate \
      --posix \
      --length "${CONF_SWAPSIZE}M" \
      "${CONF_SWAPFILE}"
  fi

  # Now generate file
  UNIT_NAME="$( \
    systemd-escape \
      --path \
      --suffix=swap \
      "${CONF_SWAPFILE}" \
  )"

  cat <<EOF > /run/systemd/generator/"${UNIT_NAME}"
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}

[Swap]
What="${CONF_SWAPFILE}"
EOF

fi
