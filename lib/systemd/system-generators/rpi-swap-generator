#!/bin/sh
# This script uses 'local' variables and expects a shell that supports them (e.g., dash)
# shellcheck disable=SC3043  # Ignore 'local' is undefined warnings

set -e

: "${CONFIG_FILE:=/etc/rpi-swap/swap.conf}"
: "${SWAP_FILE_SIZE_CALC_BIN:=/bin/rpi-desired-swap-size}"

# Function to create a service that removes the swap file
create_remove_swap_file_service() {
  local swap_file="$1"

  cat <<EOF > /run/systemd/generator/rpi-remove-swap-file.service
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
DefaultDependencies=no
After=systemd-remount-fs.service
Requires=systemd-remount-fs.service

[Service]
Type=oneshot
ExecStart=rm -f ${swap_file}
EOF
  mkdir -p /run/systemd/generator/local-fs.target.wants
  ln -s "../rpi-remove-swap-file.service" /run/systemd/generator/local-fs.target.wants/rpi-remove-swap-file.service
}

# Function to create a swap unit file
create_swap_unit() {
  local what_device="$1"
  local unit_depends="$2"

  # Derive the unit filename from the device path
  local unit_filename
  unit_filename="$(systemd-escape --path --suffix=swap "${what_device}")"
  local unit_path="/run/systemd/generator/${unit_filename}"

  cat <<EOF > "${unit_path}"
# Automatically generated by rpi-swap-generator

[Unit]
SourcePath=${CONFIG_FILE}
Requires=${unit_depends}
After=${unit_depends}

[Swap]
What=${what_device}
EOF

  # Create directory for the symlink if it doesn't exist
  mkdir -p /run/systemd/generator/swap.target.wants

  # Create symlink to enable the unit
  ln -s "../${unit_filename}" /run/systemd/generator/swap.target.wants/"${unit_filename}"
}

# Function to create systemd drop-in configuration files
create_systemd_drop_in() {
  local base_path="$1"         # e.g. 'generator' or 'zram-generator.conf.d'
  local target_name="$2"       # e.g. 'systemd-zram-setup@zram0.service' or empty for base config
  local config_name="$3"       # e.g. 'bindings.conf' or '80-rpi-enable.zram.conf'
  local content="$4"           # The content to write to the file

  local dir_path
  local file_path

  if [ -n "${target_name}" ]; then
    # Creating a drop-in for a specific service
    dir_path="/run/systemd/${base_path}/${target_name}.d"
    file_path="${dir_path}/${config_name}"
  else
    # Creating a conf file directly in the base_path
    dir_path="/run/systemd/${base_path}"
    file_path="${dir_path}/${config_name}"
  fi

  # Create directory if it doesn't exist
  mkdir -p "${dir_path}"

  # Create the configuration file
  cat <<EOF > "${file_path}"
# Automatically generated by rpi-swap-generator

${content}
EOF
}

# Function to set up zram mechanisms (both zram and zram+file)
setup_zram_mechanism() {
  local mechanism="$1"  # Either "zram" or "zram+file"
  local zram_config="[zram0]
host-memory-limit=none
fs-type=swap"
  local bindings="[Unit]
BindsTo=dev-%i.swap"

  # For zram+file, set up backing file and add to config
  if [ "${mechanism}" = "zram+file" ]; then
    BACKING_FILE="$( \
      systemd-escape \
        --path \
        "${CONF_SWAPFILE}" \
    )"
    LOOP_DEVICE="/dev/disk/by-backingfile/${BACKING_FILE}"

    # Add writeback device to zram config
    zram_config="${zram_config}
writeback-device=${LOOP_DEVICE}"

    # Add loop device to bindings
    bindings="${bindings} rpi-setup-loop@${BACKING_FILE}.service"
  fi

  # Create zram configuration
  create_systemd_drop_in \
    "zram-generator.conf.d" \
    "" \
    "80-rpi-enable.zram.conf" \
    "${zram_config}"

  # Create a swap unit
  create_swap_unit "/dev/zram0" "systemd-zram-setup@zram0.service"

  # Create the bindings
  create_systemd_drop_in \
    "generator" \
    "systemd-zram-setup@zram0.service" \
    "bindings.conf" \
    "${bindings}"
}

: "${CONF_SWAPFILE:=/var/swap}"
eval "$( \
  apt-config \
    --config-file "${CONFIG_FILE}" \
    shell \
      CONF_MECHANISM     RpiSwap::Mechanism \
      CONF_SWAPFILE      RpiSwap::Swapfile::Path \
      CONF_SWAPFACTOR    RpiSwap::Swapfile::SwapFactor \
      CONF_MAXDISK_PCT   RpiSwap::Swapfile::MaxDiskPct \
      CONF_MAXSWAP       RpiSwap::Swapfile::MaxSwap \
      CONF_SWAPSIZE      RpiSwap::Swapfile::SwapSize
)"

# Set default mechanism to "auto" if not specified in config
: "${CONF_MECHANISM:=auto}"

# Sanitize mechanism - ensure it's one of the allowed values
case "${CONF_MECHANISM}" in
  swapfile|zram|zram+file|auto)
    # Valid mechanism, do nothing
    ;;
  *)
    # Invalid mechanism, default to auto
    CONF_MECHANISM="auto"
    ;;
esac

# Handle auto mechanism by checking device tree
if [ "${CONF_MECHANISM}" = "auto" ]; then
  # Check if we're on BCM2710 lineage (Raspberry Pi 3 and derivatives)
  if [ -f "/proc/device-tree/compatible" ] && grep -q "bcm2710" "/proc/device-tree/compatible"; then
    # BCM2710 detected - use zram+file
    CONF_MECHANISM="zram+file"
  else
    # Not BCM2710 or can't determine - use swapfile
    CONF_MECHANISM="swapfile"
  fi
fi

# For 'zram' mechanism, we don't need a swap file at all
if [ "${CONF_MECHANISM}" = "zram" ]; then
  # Skip calculation and set swap size to 0
  CONF_SWAPSIZE="0"
else
  # Calculate swap size for other mechanisms
  export \
    CONF_SWAPFILE \
    CONF_SWAPFACTOR \
    CONF_MAXDISK_PCT \
    CONF_MAXSWAP \
    CONF_SWAPSIZE
  CONF_SWAPSIZE="$(${SWAP_FILE_SIZE_CALC_BIN})"
fi

CONF_SWAPFILE="$(realpath "${CONF_SWAPFILE}")"

if [ "${CONF_MECHANISM}" = "zram" ]; then
  setup_zram_mechanism "zram"
  if [ -f "${CONF_SWAPFILE}" ]; then
    create_remove_swap_file_service "${CONF_SWAPFILE}"
  fi
elif [ "${CONF_MECHANISM}" = "zram+file" ]; then
  setup_zram_mechanism "zram+file"
  # TODO: There's no swapfile resize logic currently for this case
elif [ "${CONF_SWAPSIZE}" -ne 0 ]; then # Assumed 'swapfile' case
  create_swap_unit "${CONF_SWAPFILE}" "rpi-resize-swap-file.service"
elif [ -f "${CONF_SWAPFILE}" ]; then
  create_remove_swap_file_service "${CONF_SWAPFILE}"
fi
